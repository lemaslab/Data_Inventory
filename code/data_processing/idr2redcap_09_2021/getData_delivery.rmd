---
title: "IDR-to-Redcap: mom-prenatal-bmi"
author: "Dominick J. Lemas"
date: "09/30/2021"
output: html_document

---

```{r, include=FALSE}
##-------------- 
# **************************************************************************** #
# ***************                Project Overview              *************** #
# **************************************************************************** #

# Author:            Dominick J. Lemas 
# Start Date:        October 04, 2021 
# Last Modified:      
# IRB:               UFHealth  
#                    
#
# version: R version 4.0.3 (2020-10-10)
# version: Rstudio version Version 1.3.1073 

# **************************************************************************** #
# ***************                Objective                     *************** #
# **************************************************************************** #

#  (1) Descriptive statistics on IDR data. 
#  (2) Process IDR data. 
#  (3) Outputs for downstream import-ready files for RedCap. 


```

#### __Data Processing Summary__
![](dataprocessing_workflow.png)
The data processing workflow . . . 
the first step is X and second step is y and the final step is Z. 


```{r, include=FALSE, echo=FALSE}

# **************************************************************************** #
# ***************                Libraries                     *************** #
# **************************************************************************** #

library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(lubridate)
library(stringr)

```


```{r, warning=FALSE, echo=FALSE}

# **************************************************************************** #
# ***************              baby-delivery                                             
# **************************************************************************** #
# rows:            28530
# cols:            20 
# unique baby id:  28530
# repeat:          1
# ICD9/10:         NA


# EXTRACT DATA FROM EXCEL

n_max=1000000
data_file_name="baby_mom_at_birth_with_payer.csv"
data_dir=paste0("~/ehr-database/data/raw/dataset_09_2021/")
data_import_path=paste0(data_dir,data_file_name)

# read data
delivery=read_csv(data_import_path) 

# rename
# note: renaming to eliminate spaces 
newdata=rename(delivery, 
               baby_id = `Deidentified_baby_ID`, 
               part_race=Race,
               part_ethnicity=Ethnicity, 
               part_dob=`Date of Delivery`, 
               birth_wt_gr=`Birth Weight`,
               delivery_mode.raw=`Pediatric Delivery Type`,
               delivery_admit_source=`Admit Source`,
               gest_age=`Pediatric Gestational Age`, 
               gender=Sex, 
               mom_id=Deidentified_mom_ID,
               delivery_admit_date=`Admit Date_mom`, 
               mom_race=Race_mom,
               mom_ethnicity=Ethnicity_mom,
               mom_age_delivery=`Age at Encounter_mom`,
               health_insurance=Payer_mom,
               mom_admit_height_in=`Admit Height (in)`,
               mom_admit_weight_lbs=`Admit Weight (lbs)`,
               mom_admit_weight_kgs=`Admit Weight (kg)`,
               mom_admit_height_cm=`Admit Height (cm)`,
               mom_admit_bmi=`Admit BMI` )

baby=newdata %>%
  select(-mom_race,-mom_race, 
         -mom_ethnicity,
         -mom_age_delivery,
         -mom_admit_height_in, 
         -mom_admit_weight_lbs, 
         -mom_admit_weight_kgs,
         -mom_admit_height_cm, 
         -mom_admit_bmi, 
         -mom_id,
         -part_race,
         -part_ethnicity,
         -gender)

# format dates
baby_ready = baby %>%
  mutate(part_dob=mdy_hm(part_dob),
         delivery_admit_date=mdy(delivery_admit_date))

# FORMAT FOR REDCAP

data_ready=baby_ready %>%
  mutate(redcap_repeat_instrument="delivery",
         redcap_event_name=paste0(year(delivery_admit_date),"_arm_1")) %>%
         mutate(delivery_mode=gsub(" ","_",delivery_mode.raw)) %>%
  mutate(delivery_mode=gsub(",","&",delivery_mode),
         part_id=paste0("baby-",baby_id),
         baby_id=paste0("baby-",baby_id),
         birth_wt_units="GRAMS",
         birth_wt_measure="BIRTH-WEIGHT",
         gest_age_measure="GESTATIONAL-AGE",
         gest_age_units="WEEK DAY/WK") %>%
  group_by(part_id,redcap_event_name,delivery_admit_date) %>% mutate(redcap_repeat_instance = row_number()) %>%
  select("part_id","redcap_repeat_instrument","redcap_repeat_instance","redcap_event_name",everything()) %>%
  select(-delivery_mode.raw,-baby_id) 

data_ready

## EXPORT FOR REDCAP

# export variables
batchSize=12000; # number of rows in single output file
data_file_name_export=paste0("baby_",as.character(data_ready[2,2]))
output_dir=paste0("~/ehr-database/data/processed/redcap_ready/delivery/")
data_export_path=paste0(output_dir,data_file_name_export)

# Note: expecting to expot to PATH: ~/ehr-database/data/processed/redcap_ready/delivery/
# NA: missing values are coded as "empty" in output

# number of import files
 chunks=split(data_ready, floor(0:(nrow(data_ready)-1)/batchSize))

# export each "chunk" of redcap-ready data
 for (i in 1:length(chunks))
   { # second loop
   write.table(chunks[[i]],paste0(data_export_path,i,'.csv'),row.names=F,na = "", sep=",")
   } # end second loop        


```

```{r, warning=FALSE, echo=FALSE}

# **************************************************************************** #
# ***************              mom-delivery                                             
# **************************************************************************** #
# rows:            28530
# cols:            20 
# unique baby id:  28530
# repeat:          1
# ICD9/10:         NA


# EXTRACT DATA FROM EXCEL

n_max=1000000
data_file_name="baby_mom_at_birth_with_payer.csv"
data_dir=paste0("~/ehr-database/data/raw/dataset_09_2021/")
data_import_path=paste0(data_dir,data_file_name)

# read data
delivery=read_csv(data_import_path) 

# rename
# note: renaming to eliminate spaces 
newdata=rename(delivery, 
               baby_id = `Deidentified_baby_ID`, 
               part_race=Race,
               part_ethnicity=Ethnicity, 
               part_dob=`Date of Delivery`, 
               birth_wt_gr=`Birth Weight`,
               delivery_mode.raw=`Pediatric Delivery Type`,
               delivery_admit_source=`Admit Source`,
               gest_age=`Pediatric Gestational Age`, 
               gender=Sex, 
               mom_id=Deidentified_mom_ID,
               delivery_admit_date=`Admit Date_mom`, 
               mom_race=Race_mom,
               mom_ethnicity=Ethnicity_mom,
               mom_admit_age_yr=`Age at Encounter_mom`,
               health_insurance=Payer_mom,
               mom_admit_ht_in=`Admit Height (in)`,
               mom_admit_wt_lbs=`Admit Weight (lbs)`,
               mom_admit_wt_kgs=`Admit Weight (kg)`,
               mom_admit_ht_cm=`Admit Height (cm)`,
               mom_admit_bmi=`Admit BMI` )

mom=newdata %>%
  select(-part_race,
         -part_ethnicity,
         -gender,
         -part_dob,
         -birth_wt_gr,
         -delivery_mode.raw,
         -delivery_admit_source,
         -gest_age,
         -gender,
         -mom_id,
         -mom_race,
         -mom_ethnicity)

# format dates
mom_ready = mom %>%
  mutate(delivery_admit_date=mdy(delivery_admit_date))

# FORMAT FOR REDCAP

data_ready=mom_ready %>%
  mutate(redcap_repeat_instrument="delivery",
         redcap_event_name=paste0(year(delivery_admit_date),"_arm_1")) %>%
  mutate(part_id=paste0("baby-",baby_id),
         mom_admit_bmi_units="kg/m2",
         mom_admit_bmi_measure="ADMIT-BMI",
         mom_admit_wt_measure="ADMIT-WEIGHT",
         mom_admit_wt_lbs_units="POUNDS",
         mom_admit_wt_kgs_units="KILOGRAMS",
         mom_admit_ht_measure="ADMIT-HEIGHT",
         mom_admit_ht_in_units="INCHES",
         mom_admit_ht_cm_units="CENTIMETERS",
         mom_admit_age_measure="ADMIT-AGE",
         mom_admit_age_yr_units="YEARS") %>%
  group_by(part_id,redcap_event_name,delivery_admit_date) %>% mutate(redcap_repeat_instance = row_number()) %>%
  select("part_id","redcap_repeat_instrument","redcap_repeat_instance","redcap_event_name",everything()) %>%
  select(-baby_id) 

data_ready

## EXPORT FOR REDCAP

# export variables
batchSize=12000; # number of rows in single output file
data_file_name_export=paste0("mom_",as.character(data_ready[2,2]))
output_dir=paste0("~/ehr-database/data/processed/redcap_ready/delivery/")
data_export_path=paste0(output_dir,data_file_name_export)

# Note: expecting to expot to PATH: ~/ehr-database/data/processed/redcap_ready/delivery/
# NA: missing values are coded as "empty" in output

# number of import files
 chunks=split(data_ready, floor(0:(nrow(data_ready)-1)/batchSize))

# export each "chunk" of redcap-ready data
 for (i in 1:length(chunks))
   { # second loop
   write.table(chunks[[i]],paste0(data_export_path,i,'.csv'),row.names=F,na = "", sep=",")
   } # end second loop        


```