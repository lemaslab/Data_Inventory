---
title: 'IDR-to-RedCap: baby vaccines'
author: "Hailey Ballard"
date: "10/3/2021"
output: html_document
---

---
title: "IDR-to-Redcap: ehr data processing"
author: "Dominick J. Lemas"
date: "09/30/2021"
output: html_document

---

```{r, include=FALSE}
##-------------- 
# **************************************************************************** #
# ***************                Project Overview              *************** #
# **************************************************************************** #

# Author:            Hailey Ballard
# Start Date:        October 03, 2021 
# Last Modified:      
# IRB:               UFHealth  
#                    
#
# version: R version 4.0.3 (2020-10-10)
# version: Rstudio version Version 1.3.1073 

# **************************************************************************** #
# ***************                Objective                     *************** #
# **************************************************************************** #

#  (1) Descriptive statistics on IDR data. 
#  (2) Process IDR data. 
#  (3) Outputs for downstream import-ready files for RedCap. 


```

#### __Data Processing Summary__
![](dataprocessing_workflow.png)
The data processing workflow . . . 
the first step is X and second step is y and the final step is Z. 


```{r, include=FALSE, echo=FALSE}

# **************************************************************************** #
# ***************                Libraries                     *************** #
# **************************************************************************** #

library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(lubridate)
library(stringr)

```


```{r, warning=FALSE, echo=FALSE}

# **************************************************************************** #
# ***************                baby_vaccines                                            
# **************************************************************************** #
# rows:            28529
# cols:            3 
# unique baby id:  28529
# repeat:          1
# ICD9/10:         NA

# variables
# baby_id, vaccine_date, vaccine_name


# EXTRACT DATA FROM EXCEL

# import variables
n_max=1000000
data_file_name="baby_vacinne.csv"
data_dir=paste0("~/ehr-database/data/raw/dataset_09_2021/")
data_import_path=paste0(data_dir,data_file_name)

# read data
vaccines=read_csv(data_import_path) 

# rename
# note: renaming to eliminate spaces EVEN THOUGH we will rename or drop later.
newdata=rename(vaccines, 
               baby_id = `Deidentified_baby_ID`, 
               vaccine_date = `Immune Date`,
               vaccine_name = `Immunization Name`)


# format dates
vaccines_ready = newdata %>%
  mutate(vaccine_date=mdy(vaccine_date))

# FORMAT FOR REDCAP

vaccines_ready=vaccines_ready %>%
  mutate(redcap_repeat_instrument="Vaccines",
         redcap_event_name=paste0(year(vaccine_date),"_arm_1")) %>%
         mutate(vaccine_name=gsub(" ","_",vaccine_name)) %>%
  mutate(vaccine_name=gsub(",","&",vaccine_name),
         part_id=paste0("baby-",baby_id),
         baby_id=paste0("baby-",baby_id)) %>%
  group_by(baby_id, redcap_event_name,vaccine_date) %>% mutate(redcap_repeat_instance = row_number()) %>%
  select("baby_id", "redcap_repeat_instrument","redcap_repeat_instance","redcap_event_name",,everything()) 
  
#vaccines_ready

## EXPORT FOR REDCAP

# export variables
batchSize=10000; # number of rows in single output file
data_file_name_export=paste0("baby_",as.character(vaccines_ready[2,2]))
output_dir=paste0("~/ehr-database/data/processed/redcap_ready/vaccines/")
data_export_path=paste0(output_dir,data_file_name_export)

# Note: expecting to expot to PATH: ~/ehr-database/data/processed/redcap_ready/delivery/
# NA: missing values are coded as "empty" in output

# number of import files
 chunks=split(vaccines_ready, floor(0:(nrow(vaccines_ready)-1)/batchSize))

# export each "chunk" of redcap-ready data
 for (i in 1:length(chunks))
   { # second loop
   write.table(chunks[[i]],paste0(data_export_path,i,'.csv'),row.names=F,na = "", sep=",")
   } # end second loop        



```
