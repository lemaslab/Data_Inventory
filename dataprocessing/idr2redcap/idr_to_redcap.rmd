---
title: "IDR-to-Redcap: ehr data processing"
author: "Dominick J. Lemas"
date: "08/13/2021"
output: html_document

---

```{r, include=FALSE}
##-------------- 
# **************************************************************************** #
# ***************                Project Overview              *************** #
# **************************************************************************** #

# Author:            Dominick J. Lemas 
# Start Date:        August 13, 2021 
# Last Modified:      
# IRB:               UFHealth  
#                    
#
# version: R version 4.0.3 (2020-10-10)
# version: Rstudio version Version 1.3.1073 

# **************************************************************************** #
# ***************                Objective                     *************** #
# **************************************************************************** #

#  (1) Descriptive statistics on IDR data. 
#  (2) Process IDR data. 
#  (3) Outputs for downstream import-ready files for RedCap. 


```

#### __Data Processing Summary__
![](dataprocessing_workflow.png)
The data processing workflow . . . 
the fisrt step is X and second setep is y and the final step is Z. 

```{r, include=FALSE, echo=FALSE}

# **************************************************************************** #
# ***************                Libraries                     *************** #
# **************************************************************************** #

library(readxl)
library(tidyr)
library(dplyr)
library(tidyverse)
library(lubridate)

```

```{r, warning=FALSE, echo=FALSE}

# EXTRACT DATA FROM EXCEL

# import data
n_max=1000000
data.file.name="baby.xlsx";data.file.name

# **************************************************************************** #
# ***************                baby_demography                                              
# **************************************************************************** #
# rows:       16684
# cols:       10 
# unique id:  16684
# repeat:     1
# ICD9/10:    NA

# read data
baby=read_xlsx(data.file.name, sheet = "baby", range = NULL, col_names = TRUE,
          col_types = NULL, na = "NA", trim_ws = TRUE, skip = 0, n_max = Inf,
          guess_max = min(1000, n_max));baby

# rename
newdata=rename(baby, part_id = `Baby-Id`, baby_dob=DOB, baby_race=Race, 
               baby_ethnicity=Ethnicity, baby_birth_wt_gr=`Birth Weight (grams)`, 
               baby_admit_date=`Admit Date`, baby_admit_source=`Admit Source`,
               baby_nicu_los=`NICU LOS`,baby_gest_age=Gestational_Age, delivery_mode.tmp=Delivery_Mode);newdata

# unique ID? Some moms had multiple babies in data set
length(unique(newdata$part_id)) # 16684
length(newdata$part_id)         # 16684
names(newdata); head(newdata)

## FORMAT FOR REDCAP

# need to make instance more dynamic (loop within each year)
data_ready=newdata %>%
  mutate(redcap_repeat_instrument="baby_demography", redcap_repeat_instance=1,
         redcap_event_name=paste0(year(baby_admit_date),"_arm_1")) %>% 
  mutate(delivery_mode=gsub(" ","_",delivery_mode.tmp)) %>%
  mutate(delivery_mode=gsub(",","&",delivery_mode)) %>%
  select("part_id","redcap_repeat_instrument","redcap_repeat_instance","redcap_event_name",everything()) %>%
  select(-delivery_mode.tmp) %>%
  na.omit(baby_nicu_los)

## EXPORT FOR REDCAP

dt5=data_ready

batchSize=10000; # number of rows in single output file
data.file.name.export=as.character(dt5[2,2]);data.file.name.export


chunks=split(dt5, floor(0:(nrow(dt5)-1)/batchSize))
for (i in 1:length(chunks))
  { # second loop
  write.table(chunks[[i]],paste0(data.file.name.export,i,'.csv'),row.names=F, sep=",")
  } # end second loop        


```


